<!DOCTYPE html>  <html lang="en">  
<head>  
<meta charset="utf-8"/>  
<meta name="theme-color" content="#00b7d4">
<meta name="viewport" content="width=device-width,initial-scale=1"/>  
<title>BixMAX Checkout</title>  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">  
<script src="https://js.paystack.co/v1/inline.js"></script>  <style>  
:root{--brand:#b8860b;--brand-dark:#8b6508;--ink:#1f1f1f;--bg:#f7f7f9;--card:#fff;}  
*{box-sizing:border-box;}  
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);}  
a{color:inherit;text-decoration:none;}  
header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:#111;color:#fff;}  
.brand img{height:90px;width:auto;border-radius:6px;}  
.nav{display:flex;gap:14px;}  
.nav a{padding:8px 10px;border-radius:8px;}  
.nav a:hover{background:rgba(255,255,255,.08);}  
#checkout{padding:26px 16px;max-width:900px;margin:0 auto 26px;}  
form.checkout{background:#fff;border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.06);}  
.fields{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}  
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:16px;}  
.order-summary{margin-top:16px;background:#fafafa;border-radius:12px;padding:12px;}  
.pay-row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0;}  
.place{width:100%;background:#111;color:#fff;border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;}  
.note{font-size:12px;color:#666;}  
.success{background:#e9ffe9;border:1px solid #a7e7a7;color:#0a5d0a;padding:12px;border-radius:12px;margin-top:12px;display:none;}  
footer{padding:24px 16px;text-align:center;background:#111;color:#bbb;margin-top:26px;}  
.cart-btn {
  position: fixed;
  top: 20px;
  right: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  text-decoration: none;
  padding: 10px 25px;
  background: linear-gradient(90deg, #00b7d4, #ffb300);
  border-top-left-radius: 50px;
  border-bottom-left-radius: 50px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
  box-shadow: 0 4px 15px rgba(255, 136, 0, 0.4);
  z-index: 999;
  transition: all 0.3s ease;
}

/* hover effect */
.cart-btn:hover {
  box-shadow: 0 6px 25px rgba(255, 136, 0, 0.6);
  transform: translateX(-3px);
}

/* counter badge */
#cartCount {
  position: absolute;
  top: -2px;
  right: 17px;
  background: red;
  color: white;
  font-size: 13px;
  font-weight: bold;
  border-radius: 50%;
  padding: 2px 6px;
  box-shadow: 0 0 6px rgba(255,0,0,0.5);
}

  
#loaderOverlay {  
  position: fixed;  
  top: 0; left: 0;  
  width: 100%; height: 100%;  
  background: rgba(255,255,255,0.9);  
  display: none;  
  align-items: center;  
  justify-content: center;  
  flex-direction: column;  
  z-index: 9999;  
}  
.spinner {  
  border: 4px solid #f3f3f3;  
  border-top: 4px solid #b8860b;  
  border-radius: 50%;  
  width: 40px;  
  height: 40px;  
  animation: spin 1s linear infinite;  
}  
@keyframes spin {   
  0% { transform: rotate(0deg); }   
  100% { transform: rotate(360deg); }   
}  
#loaderOverlay p {  
  margin-top: 12px;  
  font-weight: 600;  
  color: #333;  
}  
.place:disabled {  
  background: #ccc;  
  cursor: not-allowed;  
}  
.place:not(:disabled) {  
  background: #00b7d4;  
}  
.place:not(:disabled):hover {  
  background: var(--brand-dark);  
}  
</style>  </head>  
<body>  
<header>  
 <div class="cart-icon">
  <a href="/Cart/" class="cart-btn">    
 <a href="/Cart/" class="cart-btn" id="cartIcon">ðŸ›’<span id="cartCount">0</span></a>
  </a>
</div>
</header>
  <section id="checkout" class="section">  
    <h2>Checkout</h2> 
  <form class="checkout" onsubmit="return submitOrder(event)">  
    <div class="fields">  
      <div><label>Full Name</label><input id="name" placeholder="*john doe" required /></div>  
      <div><label>Phone</label><input id="phone" placeholder="*0541234567" required /></div>  
      <div><label>Email</label><input id="email" type="email" placeholder="*name@example.com" required /></div>  
      <div style="grid-column:1/-1"><label>Delivery Address</label><input id="address" placeholder="*street, town" required /></div>  
    </div>  
    <!-- Hidden lat/lng -->  
    <input type="hidden" id="latitude">  
    <input type="hidden" id="longitude">  <div class="order-summary" id="orderSummary"></div>  

<div class="pay-row">  
  <label><input type="radio" name="pay" value="pod" checked /> Pay on Delivery</label>  
  <label><input type="radio" name="pay" value="paystack" /> Pay with Paystack</label>  
</div>  
<button class="place" id="placeOrderBtn" type="submit" disabled>Place Order</button>  
<div class="success" id="successBox"></div>

  </form>  
</section>  
<div id="loaderOverlay">  
  <div class="spinner"></div>  
  <p>Processing your order...</p>  
</div>  <footer>  
  Â© <span id="year"></span> BixMAX â€” All Rights Reserved.  
</footer> 
 <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script> 

 <script>  
// Firebase config  
  const firebaseConfig = {
    apiKey: "AIzaSyB0BBzQzGX6MHVSjn09VSD-JGpSwOu8EqQ",
    authDomain: "bixmax-6c24c.firebaseapp.com",
    projectId: "bixmax-6c24c",
    storageBucket: "bixmax-6c24c.appspot.com",
    messagingSenderId: "37740442541",
    appId: "1:37740442541:web:a2e2b9bb81c6a8e76c6724"
  };  
firebase.initializeApp(firebaseConfig);  
const db = firebase.firestore();  
  
// Shop coordinates  
const shopLat = 5.647749;  
const shopLng = -0.083236;  
const feePerKm = 3.52;  
  
// Helpers  
function getCart(){ return JSON.parse(localStorage.getItem("cart"))||[]; }  
function updateBadge(){  
  let cart=getCart();  
  let qty=cart.reduce((sum,i)=>sum+(i.qty||1),0);  
  document.getElementById("cartCount").textContent=qty;  
}  
document.getElementById("year").textContent=new Date().getFullYear();  
updateBadge();  
  
// Haversine distance  
function getDistanceKm(lat1, lon1, lat2, lon2){  
  const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;  
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;  
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));  
}  
  
// Render order summary  
function renderOrderSummary(){  
  const summary = document.getElementById("orderSummary");  
  const cart = getCart();  
  const btn = document.getElementById("placeOrderBtn");  
  
  btn.disabled = true;  
  btn.textContent = "Please waitâ€¦";  
  
  if(cart.length===0){  
    summary.innerHTML="<p>Cart is empty.</p>";  
    return;  
  }  
  
  let subtotal = 0;  
  cart.forEach(i => subtotal += i.price * i.qty);  
  
  summary.innerHTML = `  
    <b>Order Summary:</b><br/>  
    ${cart.map(i=>`${i.name} x${i.qty} â€” GHâ‚µ ${i.price*i.qty}`).join("<br/>")}  
    <br/><br/>Subtotal: GHâ‚µ ${subtotal}  
    <br/>Delivery: <span id="deliveryFee">Calculatingâ€¦</span>  
    <br/><b>Total: <span id="grandTotal">Hang onâ€¦</span></b>  
  `;  
  
  const lat = parseFloat(document.getElementById("latitude").value);  
  const lng = parseFloat(document.getElementById("longitude").value);  
  
  if(!isNaN(lat)&&!isNaN(lng)){  
    const dist = getDistanceKm(shopLat, shopLng, lat, lng);  
    const deliveryFee = Math.round(dist*feePerKm);  
    const grand = subtotal + deliveryFee;  
  
    document.getElementById("deliveryFee").textContent = "GHâ‚µ " + deliveryFee;  
    document.getElementById("grandTotal").textContent = "GHâ‚µ " + grand;  
  
    btn.disabled = false;  
    btn.textContent = document.querySelector("input[name='pay']:checked").value==="paystack"   
      ? "Pay Now"   
      : "Place Order";  
  }  
}  
renderOrderSummary();  
  
// Geolocation  
if(navigator.geolocation){  
  navigator.geolocation.getCurrentPosition(pos=>{  
    document.getElementById("latitude").value = pos.coords.latitude;  
    document.getElementById("longitude").value = pos.coords.longitude;  
    renderOrderSummary();  
  }, ()=>{  
    document.getElementById("deliveryFee").textContent = "Enter address to calculate";  
    document.getElementById("grandTotal").textContent = "â€”";  
  });  
}  
  
// Paystack toggle  
const placeOrderBtn = document.getElementById("placeOrderBtn");  
document.querySelectorAll("input[name='pay']").forEach(radio=>{  
  radio.addEventListener("change",()=>{  
    placeOrderBtn.textContent = radio.value==="paystack" ? "Pay Now" : "Place Order";  
  });  
});  
  
// Wait for auth to initialize  
let currentUser = null;

firebase.auth().onAuthStateChanged(async user => {
  currentUser = user;
  if (user) {
    // Try to pre-fill from Firestore user profile
    const userDoc = await db.collection("users").doc(user.uid).get();
    if (userDoc.exists) {
      const data = userDoc.data();
      if (data.name) document.getElementById("name").value = data.name;
      if (data.phone) document.getElementById("phone").value = data.phone;
      if (data.email) document.getElementById("email").value = data.email;
      if (data.address) document.getElementById("address").value = data.address;
    } else {
      // If no profile doc yet, fill email from auth
      if (user.email) document.getElementById("email").value = user.email;
    }
  }
});

// Submit order  
function submitOrder(e){  
  e.preventDefault();  
  const cart = getCart();  
  if(cart.length===0){alert("Cart is empty."); return false;}  
  
  document.getElementById("loaderOverlay").style.display = "flex";  
  
  const subtotal = cart.reduce((s,i)=>s+i.price*i.qty,0);  
  const lat = parseFloat(document.getElementById("latitude").value);  
  const lng = parseFloat(document.getElementById("longitude").value);  
  let deliveryFee = 0;  
  if(!isNaN(lat)&&!isNaN(lng)){  
    const dist = getDistanceKm(shopLat,shopLng,lat,lng);  
    deliveryFee = Math.round(dist*feePerKm);  
  }  
  const grand = subtotal + deliveryFee;  
  
  const order = {  
    name:document.getElementById("name").value,  
    phone:document.getElementById("phone").value,  
    email:document.getElementById("email").value,  
    address:document.getElementById("address").value,  
    latitude:lat,  
    longitude:lng,  
    items:cart,  
    subtotal,  
    deliveryFee,  
    total:grand,  
    payMethod:document.querySelector('input[name="pay"]:checked').value,  
    status:"Pending",  
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),  
    
timestamps: {  
  Pending: firebase.firestore.FieldValue.serverTimestamp()  
} 
}; 
  // Attach userId if logged in  
  if(currentUser){  
    order.userId = currentUser.uid;  
    if(!order.email) order.email = currentUser.email;  
  }  
  
// Generate custom order ID: BXM + 7 digits + 1 uppercase letter
function generateCustomOrderId() {
  const numbers = Math.floor(1000000 + Math.random() * 9000000); // 7 digits
  const letter = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // Random Aâ€“Z
  return `BXM${numbers}${letter}`;
}

// Save order using custom ID as Firestore doc ID
const saveAndRedirect = async () => {
  try {
    let customId;
    let exists = true;

    // Keep generating until unique
    while (exists) {
      customId = generateCustomOrderId();
      const doc = await db.collection("orders").doc(customId).get();
      exists = doc.exists;
    }

    // Assign orderId
    order.orderId = customId;

    // Save using custom ID as document ID
    await db.collection("orders").doc(customId).set(order);

    // Save user info for next checkout
if (currentUser) {
  const userRef = db.collection("users").doc(currentUser.uid);
  await userRef.set({
    name: order.name,
    phone: order.phone,
    email: order.email,
    address: order.address,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}


    // Clear cart and redirect
    localStorage.removeItem("cart");
    updateBadge();
    setTimeout(() => {
      window.location.href = "/thankyou/?orderId=" + customId;
    }, 1000);

  } catch (err) {
    document.getElementById("loaderOverlay").style.display = "none";
    console.error(err);
    alert("Failed to submit order.");
  }
};


  
  if(order.payMethod==="paystack"){  
    let handler = PaystackPop.setup({  
      key:'pk_live_55fc4deb5da6100b52f981f9f754dc0249e7752f',  
      email:order.email||"customer@example.com",  
      amount:order.total*100,  
      currency:"GHS",  
      onClose:()=>{  
        document.getElementById("loaderOverlay").style.display = "none";  
        alert('Payment cancelled.');  
      },  
      callback:response=>{  
        order.status="Pending";  
        saveAndRedirect();  
      }  
    });  
    handler.openIframe();  
  } else {  
    saveAndRedirect();  
  }  
  
  return false;  
}  
</script> 

 <script>  
const hamburger=document.getElementById('hamburger');  
const menu=document.getElementById('menu');  
hamburger.addEventListener('click',e=>{  
  e.stopPropagation();  
  hamburger.classList.toggle('active');  
  menu.classList.toggle('active');  
});  
document.addEventListener('click',e=>{  
  if(!menu.contains(e.target)&&!hamburger.contains(e.target)){  
    menu.classList.remove('active');  
    hamburger.classList.remove('active');  
  }  
});  
</script>  </body>  
</html>
