<!DOCTYPE html>  <html lang="en">  
<head>  
<meta charset="utf-8"/>  
<meta name="theme-color" content="#00b7d4">
<meta name="viewport" content="width=device-width,initial-scale=1"/>  
<title>BixMAX Checkout</title>  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">  
<script src="https://js.paystack.co/v1/inline.js"></script>  <style>  
:root{--brand:#b8860b;--brand-dark:#8b6508;--ink:#1f1f1f;--bg:#f7f7f9;--card:#fff;}  
*{box-sizing:border-box;}  
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);}  
a{color:inherit;text-decoration:none;}  
header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:#111;color:#fff;}  
.brand img{height:90px;width:auto;border-radius:6px;}  
.nav{display:flex;gap:14px;}  
.nav a{padding:8px 10px;border-radius:8px;}  
.nav a:hover{background:rgba(255,255,255,.08);}  
#checkout{padding:26px 16px;max-width:900px;margin:0 auto 26px;}  
form.checkout{background:#fff;border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.06);}  
.fields{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}  
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:16px;}  
.order-summary{margin-top:16px;background:#fafafa;border-radius:12px;padding:12px;}  
.pay-row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0;}  
.place{width:100%;background:#111;color:#fff;border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;}  
.note{font-size:12px;color:#666;}  
.success{background:#e9ffe9;border:1px solid #a7e7a7;color:#0a5d0a;padding:12px;border-radius:12px;margin-top:12px;display:none;}  
footer{padding:24px 16px;text-align:center;background:#111;color:#bbb;margin-top:26px;}  
.cart-btn {
  position: fixed;
  top: 20px;
  right: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  text-decoration: none;
  padding: 10px 25px;
  background: linear-gradient(90deg, #00b7d4, #ffb300);
  border-top-left-radius: 50px;
  border-bottom-left-radius: 50px;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
  box-shadow: 0 4px 15px rgba(255, 136, 0, 0.4);
  z-index: 999;
  transition: all 0.3s ease;
}

/* hover effect */
.cart-btn:hover {
  box-shadow: 0 6px 25px rgba(255, 136, 0, 0.6);
  transform: translateX(-3px);
}

/* counter badge */
#cartCount {
  position: absolute;
  top: -2px;
  right: 17px;
  background: red;
  color: white;
  font-size: 13px;
  font-weight: bold;
  border-radius: 50%;
  padding: 2px 6px;
  box-shadow: 0 0 6px rgba(255,0,0,0.5);
}

  
#loaderOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(3px);
  pointer-events: none;
  transition: opacity 0.3s ease;
  display: none;
}
.loader {

  height: fit-content;
  align-items: center;
  justify-content: center;
}
.loader.active { opacity:1; pointer-events:all; }
.truckWrapper {
  width: 200px;
  height: 100px;
  display: flex;
  flex-direction: column;
  position: relative;
  align-items: center;
  justify-content: flex-end;
  overflow-x: hidden;
}
/* truck upper body */
.truckBody {
  width: 130px;
  height: fit-content;
  margin-bottom: 6px;
  animation: motion 1s linear infinite;
}
/* truck suspension animation*/
@keyframes motion {
  0% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(3px);
  }
  100% {
    transform: translateY(0px);
  }
}
/* truck's tires */
.truckTires {
  width: 130px;
  height: fit-content;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0px 10px 0px 15px;
  position: absolute;
  bottom: 0;
}
.truckTires svg {
  width: 24px;
}

.road {
  width: 100%;
  height: 1.5px;
  background-color: #282828;
  position: relative;
  bottom: 0;
  align-self: flex-end;
  border-radius: 3px;
}
.road::before {
  content: "";
  position: absolute;
  width: 20px;
  height: 100%;
  background-color: #282828;
  right: -50%;
  border-radius: 3px;
  animation: roadAnimation 1.4s linear infinite;
  border-left: 10px solid white;
}
.road::after {
  content: "";
  position: absolute;
  width: 10px;
  height: 100%;
  background-color: #282828;
  right: -65%;
  border-radius: 3px;
  animation: roadAnimation 1.4s linear infinite;
  border-left: 4px solid white;
}

.lampPost {
  position: absolute;
  bottom: 0;
  right: -90%;
  height: 90px;
  animation: roadAnimation 1.4s linear infinite;
}

@keyframes roadAnimation {
  0% {
    transform: translateX(0px);
  }
  100% {
    transform: translateX(-350px);
  }
}
.place:disabled {  
  background: #ccc;  
  cursor: not-allowed;  
}  
.place:not(:disabled) {  
  background: #00b7d4;  
}   
</style>  </head>  
<body>  
<header>  
 <div class="cart-icon">
  <a href="/Cart/" class="cart-btn">    
 <a href="/Cart/" class="cart-btn" id="cartIcon">ðŸ›’<span id="cartCount">0</span></a>
  </a>
</div>
</header>
  <section id="checkout" class="section">  
    <h2>Checkout</h2> 
  <form class="checkout" onsubmit="return submitOrder(event)">  
    <div class="fields">  
      <div><label>Full Name</label><input id="name" placeholder="*john doe" required /></div>  
      <div><label>Phone</label><input id="phone" placeholder="*0541234567" required /></div>  
      <div><label>Email</label><input id="email" type="email" placeholder="*name@example.com" required /></div>  
      <div style="grid-column:1/-1"><label>Delivery Address</label><input id="address" placeholder="*street, town" required /></div>  
    </div>  
    <!-- Hidden lat/lng -->  
    <input type="hidden" id="latitude">  
    <input type="hidden" id="longitude">  <div class="order-summary" id="orderSummary"></div>  

<div class="pay-row">  
  <label><input type="radio" name="pay" value="pod" checked /> Pay on Delivery</label>  
  <label><input type="radio" name="pay" value="paystack" /> Pay with Paystack</label>  
</div>  
<button class="place" id="placeOrderBtn" type="submit" disabled>Place Order</button>  
<div class="success" id="successBox"></div>

  </form>  
</section>  
<div id="loaderOverlay">
<div class="loader">
  <div class="truckWrapper">
    <div class="truckBody">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 198 93"
        class="trucksvg"
      >
        <path
          stroke-width="3"
          stroke="#282828"
          fill="#F83D3D"
          d="M135 22.5H177.264C178.295 22.5 179.22 23.133 179.594 24.0939L192.33 56.8443C192.442 57.1332 192.5 57.4404 192.5 57.7504V89C192.5 90.3807 191.381 91.5 190 91.5H135C133.619 91.5 132.5 90.3807 132.5 89V25C132.5 23.6193 133.619 22.5 135 22.5Z"
        ></path>
        <path
          stroke-width="3"
          stroke="#282828"
          fill="#7D7C7C"
          d="M146 33.5H181.741C182.779 33.5 183.709 34.1415 184.078 35.112L190.538 52.112C191.16 53.748 189.951 55.5 188.201 55.5H146C144.619 55.5 143.5 54.3807 143.5 53V36C143.5 34.6193 144.619 33.5 146 33.5Z"
        ></path>
        <path
          stroke-width="2"
          stroke="#282828"
          fill="#282828"
          d="M150 65C150 65.39 149.763 65.8656 149.127 66.2893C148.499 66.7083 147.573 67 146.5 67C145.427 67 144.501 66.7083 143.873 66.2893C143.237 65.8656 143 65.39 143 65C143 64.61 143.237 64.1344 143.873 63.7107C144.501 63.2917 145.427 63 146.5 63C147.573 63 148.499 63.2917 149.127 63.7107C149.763 64.1344 150 64.61 150 65Z"
        ></path>
        <rect
          stroke-width="2"
          stroke="#282828"
          fill="#FFFCAB"
          rx="1"
          height="7"
          width="5"
          y="63"
          x="187"
        ></rect>
        <rect
          stroke-width="2"
          stroke="#282828"
          fill="#282828"
          rx="1"
          height="11"
          width="4"
          y="81"
          x="193"
        ></rect>
        <rect
          stroke-width="3"
          stroke="#282828"
          fill="#DFDFDF"
          rx="2.5"
          height="90"
          width="121"
          y="1.5"
          x="6.5"
        ></rect>
        <rect
          stroke-width="2"
          stroke="#282828"
          fill="#DFDFDF"
          rx="2"
          height="4"
          width="6"
          y="84"
          x="1"
        ></rect>
      </svg>
    </div>
    <div class="truckTires">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 30 30"
        class="tiresvg"
      >
        <circle
          stroke-width="3"
          stroke="#282828"
          fill="#282828"
          r="13.5"
          cy="15"
          cx="15"
        ></circle>
        <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
      </svg>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 30 30"
        class="tiresvg"
      >
        <circle
          stroke-width="3"
          stroke="#282828"
          fill="#282828"
          r="13.5"
          cy="15"
          cx="15"
        ></circle>
        <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
      </svg>
    </div>
    <div class="road"></div>

    <svg
      xml:space="preserve"
      viewBox="0 0 453.459 453.459"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      xmlns="http://www.w3.org/2000/svg"
      id="Capa_1"
      version="1.1"
      fill="#000000"
      class="lampPost"
    >
      <path
        d="M252.882,0c-37.781,0-68.686,29.953-70.245,67.358h-6.917v8.954c-26.109,2.163-45.463,10.011-45.463,19.366h9.993
c-1.65,5.146-2.507,10.54-2.507,16.017c0,28.956,23.558,52.514,52.514,52.514c28.956,0,52.514-23.558,52.514-52.514
c0-5.478-0.856-10.872-2.506-16.017h9.992c0-9.354-19.352-17.204-45.463-19.366v-8.954h-6.149C200.189,38.779,223.924,16,252.882,16
c29.952,0,54.32,24.368,54.32,54.32c0,28.774-11.078,37.009-25.105,47.437c-17.444,12.968-37.216,27.667-37.216,78.884v113.914
h-0.797c-5.068,0-9.174,4.108-9.174,9.177c0,2.844,1.293,5.383,3.321,7.066c-3.432,27.933-26.851,95.744-8.226,115.459v11.202h45.75
v-11.202c18.625-19.715-4.794-87.527-8.227-115.459c2.029-1.683,3.322-4.223,3.322-7.066c0-5.068-4.107-9.177-9.176-9.177h-0.795
V196.641c0-43.174,14.942-54.283,30.762-66.043c14.793-10.997,31.559-23.461,31.559-60.277C323.202,31.545,291.656,0,252.882,0z
M232.77,111.694c0,23.442-19.071,42.514-42.514,42.514c-23.442,0-42.514-19.072-42.514-42.514c0-5.531,1.078-10.957,3.141-16.017
h78.747C231.693,100.736,232.77,106.162,232.77,111.694z"
      ></path>
    </svg>
  </div>
</div>
</div>

  <footer>  
  Â© <span id="year"></span> BixMAX â€” All Rights Reserved.  
</footer> 
 <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script> 

 <script>  
// Firebase config  
  const firebaseConfig = {
    apiKey: "AIzaSyB0BBzQzGX6MHVSjn09VSD-JGpSwOu8EqQ",
    authDomain: "bixmax-6c24c.firebaseapp.com",
    projectId: "bixmax-6c24c",
    storageBucket: "bixmax-6c24c.appspot.com",
    messagingSenderId: "37740442541",
    appId: "1:37740442541:web:a2e2b9bb81c6a8e76c6724"
  };  
firebase.initializeApp(firebaseConfig);  
const db = firebase.firestore();  
  
// Shop coordinates  
const shopLat = 5.791;  
const shopLng = -0.199;  
const feePerKm = 1.49;  
  
// Helpers  
function getCart(){ return JSON.parse(localStorage.getItem("cart"))||[]; }  
function updateBadge(){  
  // Clean up cart before sending to Firestore
let cart = getCart().map(item => {
  let cleaned = { ...item };
  if (cleaned.selectedVariation) {
    // rename it properly as 'size' or 'selectedSize'
    cleaned.size = cleaned.selectedVariation;
  }
  delete cleaned.sizes; // remove the full list of available sizes
  delete cleaned.selectedVariation;
  return cleaned;
});
  
  let qty=cart.reduce((sum,i)=>sum+(i.qty||1),0);  
  document.getElementById("cartCount").textContent=qty;  
}  
document.getElementById("year").textContent=new Date().getFullYear();  
updateBadge();  
  
// Haversine distance  
function getDistanceKm(lat1, lon1, lat2, lon2){  
  const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;  
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;  
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));  
}  
  
// Render order summary  
function renderOrderSummary(){  
  const summary = document.getElementById("orderSummary");  
  const cart = getCart();  
  const btn = document.getElementById("placeOrderBtn");  
  
  btn.disabled = true;  
  btn.textContent = "Please waitâ€¦";  
  
  if(cart.length===0){  
    summary.innerHTML="<p>Cart is empty.</p>";  
    return;  
  }  
  
  let subtotal = 0;  
  cart.forEach(i => subtotal += i.price * i.qty);  
  
  summary.innerHTML = `  
    <b>Order Summary:</b><br/>  
    ${cart.map(i=>`${i.name} x${i.qty} â€” GHâ‚µ ${i.price*i.qty}`).join("<br/>")}  
    <br/><br/>Subtotal: GHâ‚µ ${subtotal}  
    <br/>Delivery: <span id="deliveryFee">Calculatingâ€¦</span>  
    <br/><b>Total: <span id="grandTotal">Hang onâ€¦</span></b>  
  `;  
  
  const lat = parseFloat(document.getElementById("latitude").value);  
  const lng = parseFloat(document.getElementById("longitude").value);  
  
  if(!isNaN(lat)&&!isNaN(lng)){  
    const dist = getDistanceKm(shopLat, shopLng, lat, lng);  
    const deliveryFee = Math.round(dist*feePerKm);  
    const grand = subtotal + deliveryFee;  
  
    document.getElementById("deliveryFee").textContent = "GHâ‚µ " + deliveryFee;  
    document.getElementById("grandTotal").textContent = "GHâ‚µ " + grand;  
  
    btn.disabled = false;  
    btn.textContent = document.querySelector("input[name='pay']:checked").value==="paystack"   
      ? "Pay Now"   
      : "Place Order";  
  }  
}  
renderOrderSummary();  
  
// Geolocation  
if(navigator.geolocation){  
  navigator.geolocation.getCurrentPosition(pos=>{  
    document.getElementById("latitude").value = pos.coords.latitude;  
    document.getElementById("longitude").value = pos.coords.longitude;  
    renderOrderSummary();  
  }, ()=>{  
    document.getElementById("deliveryFee").textContent = "Enter address to calculate";  
    document.getElementById("grandTotal").textContent = "â€”";  
  });  
}  
  
// Paystack toggle  
const placeOrderBtn = document.getElementById("placeOrderBtn");  
document.querySelectorAll("input[name='pay']").forEach(radio=>{  
  radio.addEventListener("change",()=>{  
    placeOrderBtn.textContent = radio.value==="paystack" ? "Pay Now" : "Place Order";  
  });  
});  
  
// Wait for auth to initialize  
let currentUser = null;

firebase.auth().onAuthStateChanged(async user => {
  currentUser = user;
  if (user) {
    try {
      // ðŸ”Ž Query the users collection where uid == current user's uid
      const q = db.collection("users").where("uid", "==", user.uid);
      const snapshot = await q.get();

      if (!snapshot.empty) {
        // Assuming only one match
        const data = snapshot.docs[0].data();

        if (data.name) document.getElementById("name").value = data.name;
        if (data.phone) document.getElementById("phone").value = data.phone;
        if (data.email) document.getElementById("email").value = data.email;
        if (data.address) document.getElementById("address").value = data.address;
      } else {
        // If no profile doc yet, fill email from auth
        if (user.email) document.getElementById("email").value = user.email;
      }
    } catch (err) {
      console.error("Failed to load user profile:", err);
      if (user.email) document.getElementById("email").value = user.email;
    }
  }
});


// Submit order  
function submitOrder(e){  
  e.preventDefault();  
  const cart = getCart();  
  if(cart.length===0){alert("Cart is empty."); return false;}  
  
  document.getElementById("loaderOverlay").style.display = "flex";  
  
  const subtotal = cart.reduce((s,i)=>s+i.price*i.qty,0);  
  const lat = parseFloat(document.getElementById("latitude").value);  
  const lng = parseFloat(document.getElementById("longitude").value);  
  let deliveryFee = 0;  
  if(!isNaN(lat)&&!isNaN(lng)){  
    const dist = getDistanceKm(shopLat,shopLng,lat,lng);  
    deliveryFee = Math.round(dist*feePerKm);  
  }  
  const grand = subtotal + deliveryFee;  
  
  const order = {  
    name:document.getElementById("name").value,  
    phone:document.getElementById("phone").value,  
    email:document.getElementById("email").value,  
    address:document.getElementById("address").value,  
    latitude:lat,  
    longitude:lng,  
    items:cart,  
    subtotal,  
    deliveryFee,  
    total:grand,  
    payMethod:document.querySelector('input[name="pay"]:checked').value,  
    status:"Pending",  
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),  
    
timestamps: {  
  Pending: firebase.firestore.FieldValue.serverTimestamp()  
} 
}; 
  // Attach userId if logged in  
  if(currentUser){  
    order.uid = currentUser.uid;  
    if(!order.email) order.email = currentUser.email;  
  }  
  
// Generate custom order ID: BXM + 7 digits + 1 uppercase letter
function generateCustomOrderId() {
  const numbers = Math.floor(1000000 + Math.random() * 9000000); // 7 digits
  const letter = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // Random Aâ€“Z
  return `BXM${numbers}${letter}`;
}

// Save order using custom ID as Firestore doc ID
const saveAndRedirect = async () => {
  try {
    let customId;
    let exists = true;

    // Keep generating until unique
    while (exists) {
      customId = generateCustomOrderId();
      const doc = await db.collection("orders").doc(customId).get();
      exists = doc.exists;
    }

    // Assign orderId
    order.orderId = customId;

    // Save using custom ID as document ID
    await db.collection("orders").doc(customId).set(order);

if (currentUser) {
  const userQuery = await db.collection("users")
    .where("uid", "==", currentUser.uid)
    .limit(1)
    .get();

  let userRef;

  if (!userQuery.empty) {
    // User document found â†’ update it
    userRef = userQuery.docs[0].ref;
  } else {
    // No document found â†’ create one with your own auto ID
    userRef = db.collection("users").doc();
  }

  await userRef.set({
    uid: currentUser.uid,
    name: order.name,
    phone: order.phone,
    email: order.email,
    address: order.address,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}


    // Clear cart and redirect
    localStorage.removeItem("cart");
    updateBadge();
    setTimeout(() => {
      window.location.href = "/thankyou/?orderId=" + customId;
    }, 1000);

  } catch (err) {
    document.getElementById("loaderOverlay").style.display = "none";
    console.error(err);
    alert("Failed to submit order.");
  }
};


  
  if(order.payMethod==="paystack"){  
    let handler = PaystackPop.setup({  
      key:'pk_live_55fc4deb5da6100b52f981f9f754dc0249e7752f',  
      email:order.email||"customer@example.com",  
      amount:order.total*100,  
      currency:"GHS",  
      onClose:()=>{  
        document.getElementById("loaderOverlay").style.display = "none";  
        alert('Payment cancelled.');  
      },  
      callback:response=>{  
        order.status="Pending";  
        saveAndRedirect();  
      }  
    });  
    handler.openIframe();  
  } else {  
    saveAndRedirect();  
  }  
  
  return false;  
}  
</script> 

 <script>  
const hamburger=document.getElementById('hamburger');  
const menu=document.getElementById('menu');  
hamburger.addEventListener('click',e=>{  
  e.stopPropagation();  
  hamburger.classList.toggle('active');  
  menu.classList.toggle('active');  
});  
document.addEventListener('click',e=>{  
  if(!menu.contains(e.target)&&!hamburger.contains(e.target)){  
    menu.classList.remove('active');  
    hamburger.classList.remove('active');  
  }  
});  
</script>  </body>  
</html>
