<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BixMAX Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --bg-color: #f4f7fb;
      --card-bg: #ffffff;
      --text-main: #333;
      --brand-color: #0077ff;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg-color);
      margin: 0;
      padding: 20px;
    }

    h1 { margin-bottom: 20px; color: var(--text-main); }

    /* --- STATS CARDS ROW --- */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      text-align: center;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-5px); }

    .stat-title { font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .stat-value { font-size: 32px; font-weight: bold; color: var(--brand-color); margin: 10px 0; }
    .stat-desc { font-size: 12px; color: #aaa; }

    /* --- CHARTS GRID --- */
    .charts-grid {
      display: grid;
      grid-template-columns: 2fr 1fr; /* Line chart is wider */
      gap: 20px;
    }

    .chart-container {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      height: 400px;
      position: relative;
    }

    h3 { margin-top: 0; color: #555; }

    /* Loading State */
    #loading { text-align: center; margin-top: 50px; font-size: 18px; color: #666; }

    /* Responsive */
    @media (max-width: 768px) {
      .charts-grid { grid-template-columns: 1fr; } /* Stack charts on mobile */
    }
  </style>
</head>
<body>

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h1>ðŸ“Š Admin Dashboard</h1>
    <button onclick="window.location.href='/products-edit.html'" style="padding:10px 15px; cursor:pointer;">Manage Products &rarr;</button>
  </div>

  <div id="loading">Loading sales data...</div>

  <div id="dashboardContent" style="display:none;">
    
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-title">Total Revenue</div>
        <div class="stat-value" id="totalRevenue">GHâ‚µ0</div>
        <div class="stat-desc">Lifetime sales</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Total Orders</div>
        <div class="stat-value" id="totalOrders">0</div>
        <div class="stat-desc">Orders received</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Avg Order Value</div>
        <div class="stat-value" id="avgOrder">GHâ‚µ0</div>
        <div class="stat-desc">Revenue / Orders</div>
      </div>
    </div>

    <div class="charts-grid">
      
      <div class="chart-container">
        <h3>Sales Trend (Last 7 Days)</h3>
        <canvas id="salesChart"></canvas>
      </div>

      <div class="chart-container">
        <h3>Top 5 Best Sellers</h3>
        <canvas id="productsChart"></canvas>
      </div>

    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB0BBzQzGX6MHVSjn09VSD-JGpSwOu8EqQ",
    authDomain: "bixmax-6c24c.firebaseapp.com",
    projectId: "bixmax-6c24c",
    storageBucket: "bixmax-6c24c.appspot.com",
    messagingSenderId: "37740442541",
    appId: "1:37740442541:web:a2e2b9bb81c6a8e76c6724"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  // Admin Security
  const ADMIN_EMAILS = ["ydrill47@gmail.com", "favourgadri17@gmail.com"];
  onAuthStateChanged(auth, user => {
    if (!user || !ADMIN_EMAILS.includes(user.email)) {
      window.location.href = "/admin-auth/"; // Uncomment to enforce security
      console.log("Logged in as:", user ? user.email : "Guest");
    } else {
      loadDashboardData();
    }
  });
  
  // Trigger load immediately for testing (Remove if you enforce auth above)
  loadDashboardData();

  async function loadDashboardData() {
    try {
      // 1. Fetch Orders
      // We order by createdAt desc so we process recent ones properly
      const q = query(collection(db, "orders"), orderBy("createdAt", "desc")); 
      const snapshot = await getDocs(q);
      
      let totalRev = 0;
      let totalCount = 0;
      let productCounts = {};
      let salesByDate = {}; // Format: "Oct 25": 500

      // Helper dates
      const today = new Date();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(today.getDate() - 7);

      snapshot.forEach(doc => {
        const order = doc.data();
        const orderAmount = order.total || 0;
        const orderDate = order.createdAt ? order.createdAt.toDate() : new Date();
        
        // A. Global Stats
        totalRev += orderAmount;
        totalCount++;

        // B. Product Counts (for Pie Chart)
        if (order.items && Array.isArray(order.items)) {
          order.items.forEach(item => {
             // Combine sizes into one product count (e.g., "Shirt (M)" counts as "Shirt")
             // Or keep distinct. Let's keep item.name as key.
             productCounts[item.name] = (productCounts[item.name] || 0) + (item.qty || 1);
          });
        }

        // C. Sales by Date (for Line Chart)
        // Only count if within last 7 days for the chart
        if (orderDate >= sevenDaysAgo) {
            const dateStr = orderDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); // e.g., "24 Oct"
            salesByDate[dateStr] = (salesByDate[dateStr] || 0) + orderAmount;
        }
      });

      // 2. Update UI Stats
      document.getElementById("totalRevenue").textContent = "GHâ‚µ" + totalRev.toFixed(2);
      document.getElementById("totalOrders").textContent = totalCount;
      const avg = totalCount > 0 ? (totalRev / totalCount) : 0;
      document.getElementById("avgOrder").textContent = "GHâ‚µ" + avg.toFixed(2);

      // 3. Prepare Chart Data

      // --- CHART 1: TOP PRODUCTS ---
      // Sort products by count and take top 5
      const sortedProducts = Object.entries(productCounts)
        .sort((a, b) => b[1] - a[1]) // Sort descending
        .slice(0, 5);

      const topProdLabels = sortedProducts.map(i => i[0]);
      const topProdValues = sortedProducts.map(i => i[1]);

      // --- CHART 2: SALES LAST 7 DAYS ---
      // We need to ensure the dates are in order (Mon, Tue, Wed...)
      // Create an array of the last 7 days labels
      let dateLabels = [];
      let salesData = [];
      
      for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(today.getDate() - i);
          const label = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
          dateLabels.push(label);
          salesData.push(salesByDate[label] || 0); // Fill 0 if no sales that day
      }

      // 4. RENDER CHARTS
      renderSalesChart(dateLabels, salesData);
      renderProductsChart(topProdLabels, topProdValues);

      // Show Dashboard
      document.getElementById("loading").style.display = "none";
      document.getElementById("dashboardContent").style.display = "block";

    } catch (err) {
      console.error("Error loading dashboard:", err);
      document.getElementById("loading").textContent = "Error loading data. Check console.";
    }
  }

  // --- RENDER FUNCTIONS ---

  function renderSalesChart(labels, data) {
    const ctx = document.getElementById('salesChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Revenue (GHâ‚µ)',
          data: data,
          borderColor: '#0077ff',
          backgroundColor: 'rgba(0, 119, 255, 0.1)',
          tension: 0.4, // Curved line
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  function renderProductsChart(labels, data) {
    const ctx = document.getElementById('productsChart').getContext('2d');
    
    // Fallback if no sales yet
    if(data.length === 0) {
       labels = ["No Sales Yet"]; data = [1]; 
    }

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            '#0077ff',
            '#00c853',
            '#ffab00',
            '#d50000',
            '#6200ea'
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }
</script>

</body>
</html>
