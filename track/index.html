<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
<meta name="theme-color" content="#00b7d4">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BixMAX Order Tracking</title>
  <meta name="color-scheme" content="light" />
  <style>
    :root {
      --brand: #00b7d4;        
      --brand-2: #adaf;     
      --ink: #1f1f1f;        
      --muted: #6b7280;       
      --bg: #f6f7fb;      
      --card: #ffffff;   
      --ok: #16a34a;           
      --warn: #f59e0b;   
      --danger: #ef4444;  
      --line: #e5e7eb;      
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius: 16px;
    }* { box-sizing: border-box; }
html, body { height: 100%; }

body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  color: var(--ink);
  background: radial-gradient(80% 50% at 50% 0%, #fff 0%, var(--bg) 100%);
}

header {
  background: linear-gradient(180deg, var(--brand), var(--brand-2));
  color: #fff;
  padding: 18px 16px;
  box-shadow: var(--shadow);
}


main { padding: 28px 16px 48px; }
.grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
@media (min-width: 860px){ .grid { grid-template-columns: 1.1fr .9fr; } }

.card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #f1f5f9; }

.search-card { padding: 18px; display: grid; gap: 14px; }
.search-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; }
input[type="text"] {
  padding: 14px 14px; border-radius: 12px; border: 1px solid var(--line); outline: none; font-size: 16px; background: #fff;
}
input[type="text"]:focus { border-color: var(--brand); box-shadow: 0 0 0 3px #b8860b22; }
button {
  appearance: none; border: 0; cursor: pointer; padding: 14px 16px; border-radius: 12px; font-weight: 700; color: #fff; background: linear-gradient(90deg, #00b7d4, #ffb300);;
  box-shadow: 0 6px 16px rgba(184,134,11,.25);
}
button:hover { background: #00b7d4; }
.hint { color: var(--muted); font-size: 14px; }

.result-card { padding: 0; overflow: hidden; display: none; }
.result-head { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 18px; background: #fafafa; border-bottom: 1px solid var(--line); }
.meta { font-size: 12px; color: var(--muted); }
.meta .v { display: block; font-size: 18px; font-weight: 800; color: var(--ink); margin-top: 4px; }

.content { display: grid; grid-template-columns: 1fr; gap: 18px; padding: 18px; }
@media (min-width: 860px){ .content { grid-template-columns: 1fr; } }

/* PROGRESS TRACKER */
.tracker { position: relative; padding: 8px 0 4px; }
.track-line { position: absolute; left: 17px; top: 8px; bottom: 8px; width: 3px; background: #e9e9ef; border-radius: 2px; }
.step { display: grid; grid-template-columns: 34px 1fr; gap: 12px; position: relative; padding: 10px 0; }
.dot { width: 22px; height: 22px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 0 0 2px #e9e9ef; background: #cfd8e3; }
.step.completed .dot { background: green; box-shadow: 0 0 0 2px #e1c37b; }
.step.active .dot { background: var(--brand); animation: ping 1.6s infinite; box-shadow: 0 0 0 2px #e1c37b; }
.label { margin-top: 2px; }
.label .t { font-weight: 700; }
.label .s { color: var(--muted); font-size: 13px; }
.time { font-size: 12px; color: var(--muted); margin-top: 4px; }

@keyframes ping { 0% { box-shadow: 0 0 0 2px #e1c37b, 0 0 0 0 rgba(184,134,11,.35); } 70% { box-shadow: 0 0 0 2px #e1c37b, 0 0 0 14px rgba(184,134,11,0); } 100% { box-shadow: 0 0 0 2px #e1c37b, 0 0 0 0 rgba(184,134,11,0); } }

/* ORDER SUMMARY */
.summary { padding: 18px; border-top: 1px dashed var(--line); }
.summary h3 { margin: 0 0 10px; font-size: 18px; }
.row { display: flex; justify-content: space-between; gap: 10px; margin: 6px 0; font-size: 14px; }
.items { margin-top: 12px; border: 1px solid var(--line); border-radius: 12px; overflow: hidden; }
.item { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 10px 12px; border-top: 1px solid var(--line); }
.item:first-child { border-top: 0; }

/* SIDECARD (ETA + TIPS) */
.side-card { padding: 18px; }
.badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 999px; background: #fff7e6; color: #92400e; border: 1px solid #fde68a; font-weight: 700; font-size: 12px; }
.tips { margin-top: 14px; padding-top: 12px; border-top: 1px dashed var(--line); color: var(--muted); font-size: 14px; }

/* STATES */
.loading { display: none; align-items: center; gap: 8px; color: var(--muted); font-size: 14px; }
.loading .spin { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #e5e7eb; border-top-color: var(--brand); animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg);} }

.error { display: none; padding: 12px; background: #fef2f2; color: #7f1d1d; border: 1px solid #fecaca; border-radius: 12px; }
.empty { padding: 14px; color: var(--muted); text-align: center; }

.toolbar { display: flex; gap: 8px; }
.btn-line { background: #fff; color: var(--brand-2); border: 1px solid #e6e1d3; box-shadow: none; }

.foot { text-align: center; font-size: 12px; color: #9ca3af; margin-top: 18px; }
.a { color: var(--brand-2); text-decoration: none; }

.brand { display:flex; align-items:center; gap:10px; }
.brand img { height:90px; border-radius:6px; }
.nav { display:flex; gap:14px; }
.nav a { padding:8px 10px; border-radius:8px; }
.nav a:hover { background: rgba(255,255,255,.08); }
.banner {
  text-align: center;
  background: var(--brand, #b8860b);
  color: white;
  padding: 20px;
  border-radius: 10px;
  margin: 20px auto;
  max-width: 500px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}
.banner h2 {
  font-size: 1.8rem;
  margin-bottom: 10px;
}
.banner button {
  background: white;
  color: var(--brand, #b8860b);
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
.banner button:hover {
  background: #f1f1f1;
}
.hidden {
  display: none;
}
  </style>
</head>
<body>
  <header>
 
  </header> 

  <main class="wrap">
    <div class="grid">
      <!-- LEFT: Search + Result -->
      <section class="card">
        <div class="search-card">
          <div class="toolbar">
            <input id="orderIdInput" type="text" placeholder="Enter your Order ID (e.g., BX2482011)" />
            <button id="trackBtn">Track</button>
          </div>   
<a id="sampleLink" class="hint" style="display:none"></a>    
          <div id="loading" class="loading"><span class="spin"></span> Fetching orderâ€¦</div>
          <div id="error" class="error">Order not found. Please check your Order ID.</div>
        </div><div id="result" class="result-card">
      <div class="result-head">
        <div class="meta">ORDER ID<span class="v" id="vOrderId">â€”</span></div>
        <div class="meta">PLACED ON<span class="v" id="vPlaced">â€”</span></div>
      </div>

      <div class="content">
        <div>
          <div class="tracker" id="tracker">
            <div class="track-line"></div>
            <!-- Steps will be injected here -->
          </div>
<div id="orderCompleteBanner" class="hidden banner">
  <h2>ðŸŽ‰ Order Complete!</h2>
  <p>Thank you for shopping with us.</p>
  <button id="reorderBtn">Reorder</button>
</div>
          <div class="summary">
            <h3>Order Summary</h3>
            <div class="row"><span>Customer</span><strong id="vCustomer">â€”</strong></div>
            <div class="row"><span>Phone</span><strong id="vPhone">â€”</strong></div>
            <div class="row"><span>Payment</span><strong id="vPayment">â€”</strong></div>
            <div class="items" id="items"></div>
            <div class="row" style="margin-top:10px"><span>Total</span><strong id="vTotal">â€”</strong></div>
          </div>
        </div>
      </div>
    </div>

    <div class="foot">Having trouble? Contact <a class="a" href="tel:+233536345825">BixMAX Support</a></div>
  </section>

  <!-- Tips -->
  <aside class="card side-card">
    <div class="tips">
      â€¢ Keep your phone on. The rider may call you.<br/>
      â€¢ Youâ€™ll receive SMS/WhatsApp updates for major status changes.<br/>
      â€¢ Share the tracking link with a friend or family member.
    </div>
    <div style="margin-top:14px; display:flex; gap:8px;">
      <button id="copyLink" class="btn-line">Copy Link</button>
      <button id="refresh" class="btn-line">Refresh</button>
    </div>
  </aside>
</div>

  </main>  <script type="module">
    // -------- Firebase (Modular SDK) --------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 1) Replace these with your Firebase project's values
  const firebaseConfig = {
    apiKey: "AIzaSyB0BBzQzGX6MHVSjn09VSD-JGpSwOu8EqQ",
    authDomain: "bixmax-6c24c.firebaseapp.com",
    projectId: "bixmax-6c24c",
    storageBucket: "bixmax-6c24c.appspot.com",
    messagingSenderId: "37740442541",
    appId: "1:37740442541:web:a2e2b9bb81c6a8e76c6724"
  };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // -------- DOM Helpers --------
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const orderIdInput = $("#orderIdInput");
    const trackBtn = $("#trackBtn");
    const resultCard = $("#result");
    const loadingEl = $("#loading");
    const errorEl = $("#error");

    const vOrderId = $("#vOrderId");
    const vPlaced = $("#vPlaced");
    const vCustomer = $("#vCustomer");
    const vPhone = $("#vPhone");
    const vPayment = $("#vPayment");
    const vTotal = $("#vTotal");
    const trackerEl = $("#tracker");
    const itemsEl = $("#items");

    const refreshBtn = $("#refresh");
    const copyBtn = $("#copyLink");
    const sampleLink = $("#sampleLink");

    // status steps (keys expected in Firestore's `status` field)
    const STEPS = [
      { key: "Pending", title: "Order received", sub: "We got your order." },
      { key: "Preparing", title: "Preparing", sub: "Packaging your items." },
      { key: "Ontheway", title: "Out for Delivery", sub: "Rider is on the way." },
      { key: "Delivered", title: "Delivered", sub: "Order delivered." },
{ key: "Complete", title: "Completed", sub: "Order completed." }
    ];

    let unsub = null; // onSnapshot unsubscribe
    let countdownTimer = null;

    function setLoading(yes){ loadingEl.style.display = yes ? 'flex' : 'none'; }
    function setError(msg){ errorEl.textContent = msg; errorEl.style.display = 'block'; }
    function clearError(){ errorEl.style.display = 'none'; }

    function formatMoney(n, currency = 'GHS'){
      try { return new Intl.NumberFormat(undefined, { style: 'currency', currency }).format(n); }
      catch { return `${currency} ${(+n).toFixed(2)}` }
    }

    function formatDate(ts){
      if (!ts) return 'â€”';
      try {
        const d = ts instanceof Timestamp ? ts.toDate() : new Date(ts);
        return d.toLocaleString();
      } catch { return 'â€”'; }
    }

    function buildTracker(currentKey, timestamps={}){
      trackerEl.innerHTML = '';
      const currentIndex = Math.max(0, STEPS.findIndex(s => s.key === currentKey));
      STEPS.forEach((s, i) => {
        const st = document.createElement('div');
        st.className = 'step' + (i < currentIndex ? ' completed' : i === currentIndex ? ' active' : '');
        st.innerHTML = `
          <div class="dot"></div>
          <div class="label">
            <div class="t">${s.title}</div>
            <div class="s">${s.sub}</div>
            <div class="time">${formatDate(timestamps?.[s.key])}</div>
          </div>`;
        trackerEl.appendChild(st);
      });
    }

    function renderItems(items=[]) {
      itemsEl.innerHTML = '';
      if (!items.length){ itemsEl.innerHTML = '<div class="empty">No items</div>'; return; }
      items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'item';
        const name = `${it.name || 'Item'} Ã— ${it.qty || 1}`;
        const price = formatMoney(it.total ?? (it.price||0) * (it.qty||1));
        row.innerHTML = `<div>${name}</div><div><strong>${price}</strong></div>`;
        itemsEl.appendChild(row);
      });
    }

    async function fetchAndListen(orderId){
      // clean previous subscription
      if (unsub) { unsub(); unsub = null; }

      setLoading(true); clearError(); resultCard.style.display = 'none';

      const ref = doc(db, 'orders', orderId);
      const snap = await getDoc(ref);
      if (!snap.exists()){
        setLoading(false);
        setError('Order not found. Please check your Order ID.');
        return;
      }

      // live listener
      unsub = onSnapshot(ref, (docSnap) => {  
    const data = docSnap.data();  
    setLoading(false); clearError(); resultCard.style.display = 'block';  

    vOrderId.textContent = orderId;  
    vPlaced.textContent = formatDate(data.createdAt);  
    vCustomer.textContent = data.name || 'â€“';  
    vPhone.textContent = data.phone || 'â€”';  
    vPayment.textContent = (data.payMethod || 'â€”').toString();  

    const currency = data.currency || 'GHS';  
    vTotal.textContent = formatMoney(Number(data.total || 0), currency);  

    buildTracker(data.status || 'Pending', data.timestamps || {});  
    renderItems(Array.isArray(data.items) ? data.items : []);  
// Show "Order Complete" banner when status is Complete
    if (data.status === "Complete") {
      showOrderComplete(orderId);
    } else {
      document.getElementById("orderCompleteBanner").classList.add("hidden");
    }

    }, (err) => {  
    setLoading(false);  
    setError('Failed to subscribe to updates. Please retry.');  
    console.error(err);  
  });  
}  

    function getParam(){ return new URL(location.href).searchParams.get('orderId'); }

    // UI handlers
    trackBtn.addEventListener('click', () => {
      const id = orderIdInput.value.trim();
      if (!id) return;
      setParam(id); fetchAndListen(id);
    });

    orderIdInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){ trackBtn.click(); }
    });

    refreshBtn.addEventListener('click', () => {
      const id = orderIdInput.value.trim() || getParam();
      if (id) fetchAndListen(id);
    });

    copyBtn.addEventListener('click', async () => {
      const id = orderIdInput.value.trim() || getParam();
      if (!id) return;
      const url = `${location.origin}${location.pathname}?orderId=${encodeURIComponent(id)}`;
      try { await navigator.clipboard.writeText(url); copyBtn.textContent = 'Copied!'; setTimeout(()=>copyBtn.textContent='Copy Link', 1200); }
      catch { alert(url); }
    });

// grab anchor (no change if you already have)
// update / show / hide the sample link
function updateSampleLink(orderId) {
  if (!orderId) {
    sampleLink.style.display = 'none';
    sampleLink.textContent = '';
    sampleLink.removeAttribute('href');
    sampleLink.removeAttribute('target');
    return;
  }
  const url = `${location.origin}${location.pathname}?orderId=${encodeURIComponent(orderId)}`;
  sampleLink.style.display = 'inline-block';
  sampleLink.href = url;
  sampleLink.target = '_blank';
  sampleLink.textContent = url;
}

// set URL param and update link
function setParam(orderId){
  const url = new URL(location.href);
  url.searchParams.set('orderId', orderId);
  history.replaceState(null, '', url);
  updateSampleLink(orderId);   // <--- update here
}
   // Deep-link on load
const id = getParam();
if (id) {
  orderIdInput.value = id;
  updateSampleLink(id);
  fetchAndListen(id);
} else {
  updateSampleLink(null); // ensures link hidden and no '?orderId=null'
}
orderIdInput.addEventListener('input', () => {
  const id = orderIdInput.value.trim();
  updateSampleLink(id || null);
});


function showOrderComplete(orderId) {
  const banner = document.getElementById("orderCompleteBanner");
  banner.classList.remove("hidden");

  document.getElementById("reorderBtn").onclick = function() {
    // Try to load from localStorage orders
    const orders = JSON.parse(localStorage.getItem("orders")) || {};
    const order = orders[orderId];

    let cart = null;
    if (order && order.cart) {
      cart = order.cart;
    } else {
      // fallback: grab items shown on the page
      cart = [];
      document.querySelectorAll("#items .item").forEach(el => {
        const name = el.querySelector("div").textContent;
        const qty = parseInt(name.split("Ã—")[1] || "1");
        cart.push({ name, qty });
      });
    }

    if (cart && cart.length) {
      localStorage.setItem("cart", JSON.stringify(cart));
      alert("Items added to cart again! Redirecting to Checkout...");
      window.location.href = "/checkout/";
    } else {
      alert("No items found to reorder.");
    }
  };
}
  </script>
</body>
</html>
