<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BixMAX | Receipt</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      font-family: "Segoe UI", Arial, sans-serif;
      background:  #ffffff;
      color: #333;
    }

    .container {
      max-width: 700px;
      margin: 50px auto;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      padding: 30px;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    header h1 {
      color: #1976d2;
      font-size: 28px;
      margin-bottom: 5px;
    }
.thanks {
     color: rgba(0,200,100,0.9);
      font-size: 15px;
      text-align: center;
    }
    header p {
     color: rgba(0,200,100,0.9);
      font-size: 15px;
    }

    .receipt-box {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }

    .section {
      margin-bottom: 25px;
    }

    .section h2 {
      font-size: 18px;
      color: #1976d2;
      border-bottom: 2px solid #1976d2;
      display: inline-block;
      padding-bottom: 4px;
      margin-bottom: 12px;
    }

    .info p {
      margin: 4px 0;
      font-size: 15px;
    }

    .table-header, .table-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
      align-items: center;
      text-align: left;
    }

    .table-header {
      background: #f5f5f5;
      font-weight: bold;
    }

    .table-row:last-child {
      border-bottom: none;
    }

    .total {
      text-align: right;
      font-size: 18px;
      font-weight: bold;
      margin-top: 15px;
      color: #1976d2;
    }

    .back-btn {
      display: block;
      margin-top: 25px;
      text-align: center;
      text-decoration: none;
      background: #1976d2;
      color: white;
      font-weight: bold;
      padding: 10px 20px;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: #125ca1;
    }

    @media (max-width: 600px) {
      .table-header, .table-row {
        grid-template-columns: 1.5fr 1fr 1fr 1fr;
        font-size: 14px;
      }

    }
  </style>
</head>
<body>

  <div class="receipt-box">
      <header>
    <h1>üßæ BixMAX Order Receipt</h1>
    <p>Thank you for shopping with us!</p>
  </header>
    <div class="section">
      <h2>Order Details</h2>
      <div class="info">
        <p><strong>Order ID:</strong> <span id="orderId">Loading‚Ä¶</span></p>
        <p><strong>Date:</strong> <span id="orderDate">‚Äî</span></p>
      </div>
    </div>

    <div class="section">
      <h2>Customer Info</h2>
      <div class="info" id="customerInfo">
        <p><strong>Name:</strong> ‚Äî</p>
        <p><strong>Phone:</strong> ‚Äî</p>
        <p><strong>Address:</strong> ‚Äî</p>
      </div>
    </div>

    <div class="section">
      <h2>Purchased Items</h2>
      <div class="table-header">
        <span>Item Name</span>
        <span>Qty</span>
        <span>Unit Price</span>
        <span>Subtotal</span>
      </div>
      <div id="cartContainer"></div>
      <div class="total">Total: GH‚Çµ<span id="grandTotal">0.00</span></div>
</div>
<p class="thanks">SEE YOU AGAIN!</p>
</div>
      <button id="downloadBtn" class="back-btn" style="background:#28a745;margin-top:10px;">
  Download PDF
</button>

    <a href="/" id="homeBtn" class="back-btn">Return to Home</a>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB0BBzQzGX6MHVSjn09VSD-JGpSwOu8EqQ",
    authDomain: "bixmax-6c24c.firebaseapp.com",
    projectId: "bixmax-6c24c",
    storageBucket: "bixmax-6c24c.appspot.com",
    messagingSenderId: "37740442541",
    appId: "1:37740442541:web:a2e2b9bb81c6a8e76c6724"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(window.location.search);
  const orderId = params.get("orderId");
  const orderIdEl = document.getElementById("orderId");
  const orderDateEl = document.getElementById("orderDate");
  const cartContainer = document.getElementById("cartContainer");
  const grandTotalEl = document.getElementById("grandTotal");
  const customerInfo = document.getElementById("customerInfo");

  if (!orderId) {
    orderIdEl.textContent = "Unavailable";
    cartContainer.innerHTML = "<p style='text-align:center;color:red;'>‚ùå No order ID found.</p>";
    return;
  }

  orderIdEl.textContent = orderId;

  try {
    const docRef = db.collection("orders").doc(orderId);
    const docSnap = await docRef.get();

    if (!docSnap.exists) {
      cartContainer.innerHTML = "<p style='text-align:center;color:red;'>Order not found.</p>";
      return;
    }

    const order = docSnap.data();

    // Set customer info
    customerInfo.innerHTML = `
      <p><strong>Name:</strong> ${order.name || "N/A"}</p>
      <p><strong>Phone:</strong> ${order.phone || "N/A"}</p>
      <p><strong>Address:</strong> ${order.address || "N/A"}</p>
    `;

    // Date
    const date = order.timestamp?.seconds
      ? new Date(order.timestamp.seconds * 1000).toLocaleString()
      : new Date().toLocaleString();
    orderDateEl.textContent = date;

    // Items
    cartContainer.innerHTML = "";
    let total = 0;

    if (order.items && order.items.length > 0) {
      order.items.forEach(item => {
        const subtotal = item.qty * item.price;
        total += subtotal;
        const row = document.createElement("div");
        row.classList.add("table-row");
        row.innerHTML = `
          <span>${item.name}</span>
          <span>${item.qty}</span>
          <span>GH‚Çµ${item.price.toFixed(2)}</span>
          <span>GH‚Çµ${subtotal.toFixed(2)}</span>
        `;
        cartContainer.appendChild(row);
      });
    } else {
      cartContainer.innerHTML = "<p style='text-align:center;'>No items in this order.</p>";
    }

    grandTotalEl.textContent = total.toFixed(2);
  } catch (err) {
    console.error("Error loading receipt:", err);
    cartContainer.innerHTML = "<p style='text-align:center;color:red;'>Error loading receipt.</p>";
  }
});
</script>

<script>
  document.getElementById("homeBtn").addEventListener("click", () => {
    localStorage.removeItem("cart");
    localStorage.removeItem("grandTotal");
  });
</script>
<script>
document.getElementById("downloadBtn").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const receiptBox = document.querySelector(".receipt-box");

  // Capture the receipt box with high resolution
  const canvas = await html2canvas(receiptBox, { scale: 2, useCORS: true });
  const imgData = canvas.toDataURL("image/png");

  const pdf = new jsPDF("p", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  // Calculate image dimensions to fully fit within one A4 page
  let imgWidth = pageWidth - 20; // leave 10mm margin on each side
  let imgHeight = (canvas.height * imgWidth) / canvas.width;

  // If the image is too tall to fit, scale it down to fit height too
  if (imgHeight > pageHeight - 20) {
    imgHeight = pageHeight - 20;
    imgWidth = (canvas.width * imgHeight) / canvas.height;
  }

  const x = (pageWidth - imgWidth) / 2;
  const y = (pageHeight - imgHeight) / 2;

  pdf.addImage(imgData, "PNG", x, y, imgWidth, imgHeight);

  const orderId = document.getElementById("orderId")?.textContent.trim() || "receipt";
  pdf.save(`${orderId}_BixMAX_Receipt.pdf`);
});
</script>


</body>
</html>
