<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BixMAX Orders</title>
<style>
:root {
  --brand: #b8860b; 
  --brand-dark: #8b6508;
  --ink: #1f1f1f;
  --bg: #f7f7f9;
  --card: #ffffff;
}
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);}
a{color:inherit;text-decoration:none;}
/* Header */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;background:#111;color:#fff;
}
.brand{display:flex;align-items:center;gap:10px;}
.brand img{height:90px;width:auto;border-radius:6px;}
.nav{display:flex;gap:14px;}
.nav a{padding:8px 10px;border-radius:8px;}
.nav a:hover{background:rgba(255,255,255,.08);}

/* Orders */
.main{padding:20px; max-width:1000px;margin:0 auto;}
h1{margin-bottom:12px;color:#111;}
#searchBar{
  width:100%;padding:10px 14px;margin-bottom:20px;
  border:1px solid #ccc;border-radius:8px;font-size:16px;
}
.order{background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:16px;}
.order h2{margin:0 0 10px;font-size:18px;color:#333;}
.items p{margin:4px 0; display: flex; align-items: center; gap: 8px;}
.total{font-weight:bold;margin-top:8px;}
.status{font-weight:bold;margin-top:4px;}
/* Footer */
footer{padding:24px 16px;text-align:center;background:#111;color:#bbb;margin-top:26px;}

/* Product images */
.items img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.2s;
}
.items img:hover { transform: scale(1.1); }

/* Buttons */
.buttons { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
.buttons button {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  color: #fff;
}
.statusBtn { font-weight: bold; }
.cancel { background: #d9534f; }

/* Status colors */
.Preparing { background: #f0ad4e; }
.Ontheway { background: #5bc0de; }
.Delivered { background: #5cb85c; }
.Complete { background: #777; cursor: not-allowed; }

/* Lightbox modal */
#imgModal {
  display: none; position: fixed; z-index: 1000;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.8);
  justify-content: center; align-items: center;
}
#imgModal img {
  max-width: 90%; max-height: 90%; border-radius: 10px;
}
#imgModal span {
  position: absolute; top: 20px; right: 30px;
  color: #fff; font-size: 30px; cursor: pointer;
}

/* üîî Fullscreen New Order Popup */
#orderPopup {
  position: fixed;
  inset: 0;
  background:var(--brand);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.9rem;
  font-weight: bold;
  z-index: 9999;
  display: none;
  cursor: pointer;
}
@keyframes fadeInOut {
  0% {opacity: 0;}
  10% {opacity: 1;}
  90% {opacity: 1;}
  100% {opacity: 0;}
}
#orderPopup.show {
  display: flex;
  animation: fadeInOut 3s ease forwards;
}
.sound {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
  text-decoration: none;
  padding: 10px 20px;
  background: linear-gradient(90deg, #00b7d4, #ffb300);
  border-radius: 50px;
  box-shadow: 0 4px 15px rgba(255, 136, 0, 0.4);
  z-index: 9999;
  cursor: pointer;
  opacity: 1;            /* ‚úÖ make visible */
  pointer-events: auto;  /* ‚úÖ make clickable */
}

</style>
</head>
<body>

<!-- HEADER -->
<header>
  <nav class="nav">BixMAX ORDERSüì•</nav>
<button class="sound" id="enableSound">üîî</button>
</header>
  
<!-- ORDERS -->
<div class="main">
  <h1>Received Orders</h1>
  <input type="text" id="searchBar" placeholder="Search by OrderID, Name, Phone, or Email..."/>
  <div id="ordersContainer"></div>
</div>

<!-- Modal for image preview -->
<div id="imgModal"><span onclick="document.getElementById('imgModal').style.display='none'">&times;</span><img id="modalImg"/></div>

<!-- üîî Fullscreen New Order Popup -->
<div id="orderPopup">üö®New Orderüö®</div>
<audio id="orderSound" src="bell-ringing-03a.mp3" preload="auto"></audio>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
// Firebase config

  const firebaseConfig = {
    apiKey: "AIzaSyB0BBzQzGX6MHVSjn09VSD-JGpSwOu8EqQ",
    authDomain: "bixmax-6c24c.firebaseapp.com",
    projectId: "bixmax-6c24c",
    storageBucket: "bixmax-6c24c.appspot.com",
    messagingSenderId: "37740442541",
    appId: "1:37740442541:web:a2e2b9bb81c6a8e76c6724"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const auth = firebase.auth();

// List of allowed admins
const ADMIN_EMAILS = ["support@bixmax.store", "ydrill47@gmail.com"];
const ADMIN_PHONES = ["+233536345825"]; // E.164 format

auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "/admin-auth/";
    return;
  }

  const emailAllowed = ADMIN_EMAILS.includes(user.email);
  const phoneAllowed = user.phoneNumber && ADMIN_PHONES.includes(user.phoneNumber);

  if (!emailAllowed && !phoneAllowed) {
    // Not in the allowed list
    window.location.href = "/admin-auth/";
  }
});

const sound = document.getElementById("orderSound");
let soundEnabled = false;
let allOrders = []; // üîß moved global so search works

document.getElementById("enableSound").addEventListener("click", async () => {
  try {
    // Try to play once, then stop immediately
    await sound.play();
    await new Promise(r => setTimeout(r,200));
    sound.pause();
    sound.currentTime = 0;

    soundEnabled = true;
    const btn = document.getElementById("enableSound");
    btn.innerText = "‚úÖ Sound Enabled";
    btn.disabled = true;
    btn.style.display = "none"; // üîß hide after enabling
    console.log("Sound alerts enabled");
  } catch (err) {
    console.error("Failed to enable sound:", err);
    alert("‚ö†Ô∏è Please click again to allow sound.");
  }
});

const container = document.getElementById("ordersContainer");
const searchBar = document.getElementById("searchBar");
const statusFlow = ["Pending","Preparing","Ontheway","Delivered","Complete"];

// Show image in modal
function showImage(src){
  document.getElementById("modalImg").src = src;
  document.getElementById("imgModal").style.display = "flex";
}



// Cancel order
function cancelOrder(orderId){
  if(confirm("Are you sure you want to cancel this order?")){
    db.collection("orders").doc(orderId).update({ status: "Cancelled" })
      .then(()=>console.log(`Order ${orderId} cancelled`))
      .catch(err=>console.error(err));
  }
}

// Render orders
function renderOrder(doc){
  const o = doc.data();
  const div = document.createElement("div");
  div.className = "order";

const itemsHTML = o.items.map(i => {
  const img = i.image ? `<img src="${i.image}" alt="${i.name}" onclick="showImage('${i.image}')"/>` : "";
  const qty = i.qty || i.quantity || 1;

  // üü¢ Show selected size/variation if available
  const size = i.size || i.selectedSize || i.selectedVariation || "";

  // Optional details like color or tag
  const color = i.color ? ` | Color: ${i.color}` : "";

  // Final item line
  return `
    <p>
      ${img}
      <span>
        <b>${i.name}</b> ${size ? `(Size: ${size})` : ""}${color} √ó ${qty} 
        ‚Äî GHS ${(i.price * qty).toFixed(2)}
      </span>
    </p>
  `;
}).join("");


  const latlng = (o.latitude && o.longitude) ? ` (${o.latitude.toFixed(6)}, ${o.longitude.toFixed(6)})` : "";

  let nextStatus = "Preparing";
  const currentIndex = statusFlow.indexOf(o.status);
  if(currentIndex >= 0 && currentIndex < statusFlow.length-1){
    nextStatus = statusFlow[currentIndex+1];
  } else if(o.status === "Complete" || o.status === "Cancelled"){
    nextStatus = null;
  }

  const statusBtnHTML = nextStatus 
    ? `<button class="statusBtn ${nextStatus}" onclick="advanceStatus('${doc.id}','${nextStatus}')">${nextStatus}</button>` 
    : `<span style="color:grey;font-weight:bold;">${o.status}</span>`;
  const cancelBtnHTML = (o.status !== "Complete" && o.status !== "Cancelled") ? `<button class="cancel" onclick="cancelOrder('${doc.id}')">Cancel Order</button>` : "";

  div.innerHTML = `
    <h2>Order ID: ${doc.id}</h2>
    <p><b>Name:</b> ${o.name}</p>
    <p><b>Phone:</b> ${o.phone}</p>
    <p><b>Email:</b> ${o.email || "N/A"}</p>
    <p><b>Address:</b> ${o.address}${latlng}</p>
    <p><b>Date:</b> ${o.createdAt?.toDate ? o.createdAt.toDate().toLocaleString() : o.createdAt}</p>
    <div class="items"><b>Items:</b>${itemsHTML}</div>
    <p class="total">Total: GHS ${o.total}</p>
    <p class="status"><b>Payment:</b> ${o.payMethod} | <b>Status:</b> ${o.status}</p>
    <div class="buttons">
      ${statusBtnHTML}
      ${cancelBtnHTML}
    </div>
  `;
  container.appendChild(div);
}



// üîî Show popup
function showNewOrderPopup() {
  const popup = document.getElementById("orderPopup");

  if (soundEnabled) {
    sound.currentTime = 0;
    sound.play().catch(err => console.warn("Play blocked:", err));
  }

  popup.classList.add("show");

  popup.onclick = () => {
    if (soundEnabled) {
      sound.pause();
      sound.currentTime = 0;
    }
    popup.classList.remove("show");
  };

  setTimeout(() => {
    popup.classList.remove("show");
    if (soundEnabled) {
      sound.pause();
      sound.currentTime = 0;
    }
  }, 10000);
}

// --- New order detection baseline ---
let baselineTime = null;

// First snapshot: set baseline
db.collection("orders").orderBy("createdAt","desc").limit(1).get().then(snap=>{
  if(!snap.empty){
    baselineTime = snap.docs[0].data().createdAt?.toDate() || new Date();
  } else {
    baselineTime = new Date();
  }
});

// Real-time listener
db.collection("orders").orderBy("createdAt","desc")
  .onSnapshot(snapshot=>{
    container.innerHTML="";
    if(snapshot.empty){
      container.innerHTML="<p>No orders yet.</p>";
      return;
    }

    allOrders = []; // üîß reset global
    snapshot.forEach(doc=>{
      allOrders.push(doc);

      const orderTime = doc.data().createdAt?.toDate();
      if(orderTime && baselineTime && orderTime > baselineTime){
        showNewOrderPopup();
        baselineTime = orderTime;
      }
    });

    displayOrders(allOrders);
  },err=>{
    console.error(err);
    container.innerHTML="<p>Failed to load orders.</p>";
  });

// Display orders
function displayOrders(list){
  container.innerHTML="";
  list.forEach(doc=>renderOrder(doc));
}

// Search filter
searchBar.addEventListener("input", ()=>{
  const q = searchBar.value.toLowerCase();
  const filtered = allOrders.filter(doc=>{
    const o = doc.data();
    return doc.id.toLowerCase().includes(q) ||
           (o.name && o.name.toLowerCase().includes(q)) ||
           (o.phone && o.phone.toLowerCase().includes(q)) ||
           (o.email && o.email.toLowerCase().includes(q));
  });
  displayOrders(filtered);
});

  // ‚úÖ Status messages
const STATUS_MESSAGES = {
  "Pending": "üõí Your order has been received! We're reviewing it and will start preparing it soon.",
  "Preparing": "üç≥ Good news! Your order is being prepared. We'll make sure everything is perfect.",
  "Ontheway": "üöö Your order is on the way! It should reach you shortly. Track it for updates.",
  "Delivered": "üì¶ Your order has been delivered! We hope you enjoy it.",
  "Complete": "‚úÖ Your order is complete. Thank you for shopping with us!",
  "cancelled": "‚ùå Your order has been cancelled. If this is unexpected, please contact support."
};

// Advance status button
async function advanceStatus(orderId, newStatus) {
  const updateData = {
    status: newStatus,
    [`timestamps.${newStatus}`]: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    // 1Ô∏è‚É£ Update order status
    await db.collection("orders").doc(orderId).update(updateData);
    console.log(`Order ${orderId} updated to ${newStatus}`);

    // 2Ô∏è‚É£ Get latest order info
    const doc = await db.collection("orders").doc(orderId).get();
    const data = doc.data();
    const email = data?.email || "N/A";
    const email = data?.uid || "N/A";

    // 3Ô∏è‚É£ Create notification
    await createNotification(orderId, uid, email, newStatus);

  } catch (err) {
    console.error("Failed to advance status:", err);
    alert("Error updating status: " + err.message);
  }
}

// Create notification in top-level 'notifications' collection
async function createNotification(orderId, email, status) {
  const message = STATUS_MESSAGES[status] || `Order ${orderId} status updated to ${status}`;
  console.log("Creating notification:", { orderId, uid, email, status, message });

  try {
    const docRef = await db.collection("notifications").add({
      orderId,
      uid,
      email,
      status,
      message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      read: false
    });
    console.log("Notification successfully created with ID:", docRef.id);

  } catch (err) {
    console.error("Failed to create notification:", err);
    alert("Failed to create notification: " + err.message);
  }
}

</script>

<script>
// Prevent screen from sleeping
let wakeLock = null;
async function requestWakeLock() {
  try {
    wakeLock = await navigator.wakeLock.request("screen");
    console.log("Wake lock active");
    wakeLock.addEventListener("release", () => {
      console.log("Wake lock released, re-requesting...");
      requestWakeLock();
    });
  } catch (err) {
    console.error(`${err.name}, ${err.message}`);
    if (!("wakeLock" in navigator)) {
      alert("Your browser does not support Wake Lock. Please keep screen awake manually.");
    }
  }
}
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    requestWakeLock();
  } else if (wakeLock !== null) {
    wakeLock.release();
    wakeLock = null;
  }
});
requestWakeLock();
</script>
</body>
</html>
